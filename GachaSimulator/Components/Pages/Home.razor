@page "/"
@rendermode InteractiveServer
@using GachaSimulator.Services
@using GachaSimulator.Models
@inject GachaService GachaService
@inject IDialogService DialogService
@inject NavigationManager NavManager

<div class="genshin-bg">
    <div class="genshin-top-menu">
        <MudTooltip Text="Sự kiện"><div class="menu-icon-circle"><MudIcon Icon="@Icons.Material.Filled.Explore" /></div></MudTooltip>
        <MudTooltip Text="Nhật ký"><div class="menu-icon-circle"><MudIcon Icon="@Icons.Material.Filled.Forest" /></div></MudTooltip>
        <MudTooltip Text="Cầu nguyện"><div class="menu-icon-circle" style="background: #ECE5D8;"><MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Style="color: #333;" /></div></MudTooltip>
        <MudTooltip Text="Túi đồ">
            <div class="menu-icon-circle" @onclick='() => NavManager.NavigateTo("/items")'>
                <MudIcon Icon="@Icons.Material.Filled.Backpack" />
            </div>
        </MudTooltip>
    </div>

    <div class="gacha-container">

        @if (banners == null)
        {
            <MudProgressCircular Color="Color.Inherit" Indeterminate="true" Class="align-self-center" />
        }
        else
        {
            <div class="banner-tabs">
                @foreach (var banner in banners)
                {
                    <img src="@banner.IconUrl"
                         class="banner-tab-icon @(selectedBanner?.Id == banner.Id ? "active" : "")"
                         @onclick="() => SelectBanner(banner)"
                         title="@banner.Name" />
                }
            </div>

            <div class="banner-display">
                @if (selectedBanner != null)
                {
                    <img src="@selectedBanner.ImageUrl" class="banner-image" key="@selectedBanner.Id" />
                }
            </div>

            <div class="footer-left">
                <div class="footer-btn">Cửa Hàng</div>
                <div class="footer-btn">Chi Tiết</div>
                <div class="footer-btn">Lịch Sử</div>
            </div>

            <div class="gacha-controls">
                <button class="wish-btn" @onclick="() => Roll(1)">
                    <div>Cầu Nguyện x1</div>
                    <div class="currency-row">
                        <MudImage Src="https://api.hakush.in/gi/UI/UI_ItemIcon_223.webp" Width="35" Height="35" Class="mr-1" />
                        <span style="color: #8A8A8A;">x 1</span>
                    </div>
                </button>

                <button class="wish-btn" @onclick="() => Roll(10)">
                    <div>Cầu Nguyện x10</div>
                    <div class="currency-row">
                        <MudImage Src="https://api.hakush.in/gi/UI/UI_ItemIcon_223.webp" Width="35" Height="35" Class="mr-1" />
                        <span style="color: #8A8A8A;">x 10</span>
                    </div>
                </button>
            </div>
        }
    </div>
</div>

@code {
    private List<Banner>? banners;
    private Banner? selectedBanner;
    private bool isRolling = false;

    protected override async Task OnInitializedAsync()
    {
        //Lấy danh sách từ DB
        banners = await GachaService.GetBannersAsync();

        // 3. Chọn banner đầu tiên làm mặc định
        if (banners.Any())
        {
            selectedBanner = banners.First();
        }
    }

    private void SelectBanner(Banner banner)
    {
        selectedBanner = banner;
    }

    private async Task Roll(int times)
    {
        if (isRolling || selectedBanner == null) return;
        isRolling = true;

        // Gọi Service quay theo ID của banner đang chọn
        var results = await GachaService.RollBannerAsync(selectedBanner.Id, times);

        // Hiển thị kết quả
        var message = string.Join(", ", results.Select(r => r.Items?.Name ?? "???"));
        await DialogService.ShowMessageBox($"Kết quả: {selectedBanner.Name}", message, yesText: "Xác nhận");

        isRolling = false;
    }
}