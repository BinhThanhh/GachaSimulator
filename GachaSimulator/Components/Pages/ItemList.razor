@page "/items"
@rendermode InteractiveServer
@using GachaSimulator.Models
@using GachaSimulator.Services
@inject GachaService GachaService
@inject NavigationManager NavManager

<div class="inventory-bg">

    <div class="d-flex justify-space-between align-center mb-4 px-3">
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.Backpack" Size="Size.Large" Class="mr-3" />
            <MudText Typo="Typo.h4" Style="font-weight:bold;">Túi Đồ</MudText>
        </div>

        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit"
                       OnClick="@(() => NavManager.NavigateTo("/"))"
                       Style="background: rgba(0,0,0,0.5); border: 1px solid #fff;" />
    </div>

    <div class="d-flex gap-4 mb-4 px-3">
        <MudButton Variant="Variant.Outlined" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.Add"
                   Href="/add-item" Class="rounded-pill">
            Thêm Vật Phẩm
        </MudButton>
    </div>

    @if (items == null)
    {
        <div class="d-flex justify-center align-center" style="height: 50vh;">
            <MudProgressCircular Color="Color.Info" Indeterminate="true" />
        </div>
    }
    else
    {
        <div class="genshin-grid">
            @foreach (var item in items)
            {
                <div class="item-slot"
                     style="@GetBackgroundStyle(item.Rarity)"
                     @onclick="@(() => EditItem(item.Id))">

                    <img src="@item.ImageUrl" class="slot-image" />

                    @if (item.Element != ElementType.none)
                    {
                        <div style="position:absolute; top:4px; left:4px;">
                            <MudImage Src="@GetElementImageUrl(item.Element)" Width="20" Height="20" />
                        </div>
                    }

                    <div class="slot-stars">
                        @for (int i = 0; i < item.Rarity; i++)
                        {
                            <span class="star-icon">★</span>
                        }
                    </div>

                    <div class="slot-name">@item.Name</div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Items>? items;

    protected override async Task OnInitializedAsync()
    {
        items = await GachaService.GetAllItemsAsync();
    }

    private void EditItem(int id)
    {
        NavManager.NavigateTo($"/edit-item/{id}");
    }

    // --- HÀM QUAN TRỌNG: CHỈNH ẢNH NỀN THEO ĐỘ HIẾM ---
    private string GetBackgroundStyle(int rarity)
    {
        return rarity switch {
            5 => "background: linear-gradient(to bottom, #a37a40, #3b4255); border-bottom: 3px solid #dca452;",
            4 => "background: linear-gradient(to bottom, #7e6096, #3b4255); border-bottom: 3px solid #9c7dd6;",
            _ => "background: linear-gradient(to bottom, #4a6c8c, #3b4255); border-bottom: 3px solid #4a6c8c;"
        };
    }

    private string GetElementImageUrl(ElementType? type)
    {
        // Giữ nguyên hàm lấy icon Vision từ API
        return type switch
        {
            ElementType.pyro => "https://api.hakush.in/gi/UI/Pyro.webp",
            ElementType.hydro => "https://api.hakush.in/gi/UI/Hydro.webp",
            ElementType.anemo => "https://api.hakush.in/gi/UI/Anemo.webp",
            ElementType.electro => "https://api.hakush.in/gi/UI/Electro.webp",
            ElementType.dendro => "https://api.hakush.in/gi/UI/Dendro.webp",
            ElementType.cryo => "https://api.hakush.in/gi/UI/Cryo.webp",
            ElementType.geo => "https://api.hakush.in/gi/UI/Geo.webp",
            _ => ""
        };
    }
}